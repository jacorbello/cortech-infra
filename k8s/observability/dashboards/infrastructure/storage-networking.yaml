apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-storage-networking
  namespace: observability
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/name: grafana-dashboard
    app.kubernetes.io/component: infrastructure
    release: prometheus
  annotations:
    grafana_folder: "Infrastructure"
data:
  storage-networking.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {"type": "grafana", "uid": "-- Grafana --"},
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "id": 20,
          "panels": [],
          "title": "Proxmox Storage",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "max": 1,
              "min": 0,
              "thresholds": {"mode": "percentage", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 70}, {"color": "red", "value": 85}]},
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 1},
          "id": 1,
          "options": {"displayMode": "gradient", "minVizHeight": 10, "minVizWidth": 0, "orientation": "horizontal", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showUnfilled": true, "valueMode": "color"},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "pve_disk_usage_bytes{id=~\"storage/.*\"} / pve_disk_size_bytes{id=~\"storage/.*\"}", "legendFormat": "{{id}}", "refId": "A"}],
          "title": "Proxmox Storage Utilization",
          "type": "bargauge"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "bytes"
            },
            "overrides": []
          },
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 9},
          "id": 2,
          "options": {"legend": {"calcs": ["lastNotNull"], "displayMode": "table", "placement": "right", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "pve_disk_usage_bytes{id=~\"storage/.*\"}", "legendFormat": "{{id}}", "refId": "A"}],
          "title": "Storage Usage Over Time",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "custom": {"align": "auto", "cellOptions": {"type": "auto"}, "inspect": false},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": [
              {"matcher": {"id": "byName", "options": "Used"}, "properties": [{"id": "unit", "value": "bytes"}]},
              {"matcher": {"id": "byName", "options": "Total"}, "properties": [{"id": "unit", "value": "bytes"}]},
              {"matcher": {"id": "byName", "options": "Usage %"}, "properties": [{"id": "unit", "value": "percentunit"}, {"id": "thresholds", "value": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.7}, {"color": "red", "value": 0.85}]}}, {"id": "custom.cellOptions", "value": {"type": "color-background"}}]}
            ]
          },
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 9},
          "id": 3,
          "options": {"cellHeight": "sm", "footer": {"countRows": false, "fields": "", "reducer": ["sum"], "show": false}, "showHeader": true, "sortBy": [{"desc": true, "displayName": "Usage %"}]},
          "pluginVersion": "11.0.0",
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "pve_disk_usage_bytes{id=~\"storage/.*\"}", "format": "table", "instant": true, "refId": "A"},
            {"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "pve_disk_size_bytes{id=~\"storage/.*\"}", "format": "table", "instant": true, "refId": "B"}
          ],
          "title": "Storage Details",
          "transformations": [
            {"id": "seriesToColumns", "options": {"byField": "id"}},
            {"id": "calculateField", "options": {"alias": "Usage %", "binary": {"left": "Value #A", "operator": "/", "right": "Value #B"}, "mode": "binary", "reduce": {"reducer": "sum"}}},
            {"id": "organize", "options": {"excludeByName": {"Time": true, "Time 1": true, "Time 2": true, "__name__": true, "__name__ 1": true, "instance": true, "instance 1": true, "job": true, "job 1": true, "node": true, "node 1": true}, "indexByName": {}, "renameByName": {"Value #A": "Used", "Value #B": "Total", "id": "Storage"}}}
          ],
          "type": "table"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 16},
          "id": 21,
          "panels": [],
          "title": "Kubernetes Storage",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "max": 1,
              "min": 0,
              "thresholds": {"mode": "percentage", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 70}, {"color": "red", "value": 85}]},
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": {"h": 6, "w": 24, "x": 0, "y": 17},
          "id": 4,
          "options": {"displayMode": "gradient", "minVizHeight": 10, "minVizWidth": 0, "orientation": "horizontal", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showUnfilled": true, "valueMode": "color"},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes", "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}", "refId": "A"}],
          "title": "Kubernetes PVC Utilization",
          "type": "bargauge"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 23},
          "id": 22,
          "panels": [],
          "title": "Network Traffic",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "Bps"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "id": 5,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "sum(rate(pve_network_receive_bytes{id=~\"node/.*\"}[5m])) by (id)", "legendFormat": "{{id}} RX", "refId": "A"}],
          "title": "Proxmox Node Network RX",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "Bps"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "id": 6,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "sum(rate(pve_network_transmit_bytes{id=~\"node/.*\"}[5m])) by (id)", "legendFormat": "{{id}} TX", "refId": "A"}],
          "title": "Proxmox Node Network TX",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "Bps"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
          "id": 7,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "sum(rate(node_network_receive_bytes_total{device!=\"lo\"}[5m])) by (instance)", "legendFormat": "{{instance}} RX", "refId": "A"}],
          "title": "K3s Node Network RX",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "Bps"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
          "id": 8,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "sum(rate(node_network_transmit_bytes_total{device!=\"lo\"}[5m])) by (instance)", "legendFormat": "{{instance}} TX", "refId": "A"}],
          "title": "K3s Node Network TX",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 40},
          "id": 23,
          "panels": [],
          "title": "Traefik Ingress",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 41},
          "id": 9,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "sum(rate(traefik_entrypoint_requests_total[5m])) by (entrypoint, code)", "legendFormat": "{{entrypoint}} {{code}}", "refId": "A"}],
          "title": "Traefik Request Rate",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "${datasource}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 41},
          "id": 10,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "pluginVersion": "11.0.0",
          "targets": [{"datasource": {"type": "prometheus", "uid": "${datasource}"}, "expr": "histogram_quantile(0.99, sum(rate(traefik_entrypoint_request_duration_seconds_bucket[5m])) by (le, entrypoint))", "legendFormat": "{{entrypoint}} p99", "refId": "A"}],
          "title": "Traefik Request Latency (p99)",
          "type": "timeseries"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "tags": ["storage", "networking", "infrastructure", "cortech"],
      "templating": {
        "list": [
          {
            "current": {"selected": true, "text": "Prometheus", "value": "prometheus"},
            "hide": 0,
            "includeAll": false,
            "label": "Datasource",
            "multi": false,
            "name": "datasource",
            "options": [],
            "query": "prometheus",
            "queryValue": "",
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "type": "datasource"
          }
        ]
      },
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "browser",
      "title": "Storage & Networking",
      "uid": "storage-networking",
      "version": 1
    }
